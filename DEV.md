# 豆豆防御战 - 开发进度

## 项目概述

豆豆防御战是一款手机触屏游戏，兼容430*930的分辨率。玩家控制英雄守护水晶，抵挡从四面八方袭来的豆豆。游戏采用Phaser3框架开发，不使用任何图片资源，所有游戏元素（玩家、豆豆、技能、道具等）均使用Emoji实现。


## 当前开发阶段

当前处于单机开发阶段，一个玩家控制所有英雄。

## 技术架构

项目采用了战斗逻辑与展示层分离的架构设计：

1. **战斗引擎**：负责处理游戏的核心战斗逻辑
   - 帧管理（逻辑帧和内部帧）
   - 实体管理（英雄、豆豆、水晶）
   - 技能系统
   - 伤害计算
   - 波次管理
   - 事件系统
   - 伪随机系统
   - 回放功能

2. **展示层**：负责游戏的视觉展示和用户交互
   - 使用Phaser3框架
   - 使用Emoji代替传统图片资源
   - 处理用户输入和触屏操作

## 已实现功能

### 游戏入口和场景系统

- [x] 游戏入口文件 (main.ts)
- [x] 主菜单场景 (MainMenuScene.ts)
- [x] 关卡选择场景 (LevelSelectScene.ts)
- [x] 英雄选择场景 (HeroSelectScene.ts)
- [x] 战斗场景 (BattleScene.ts)

### 战斗引擎核心系统

- [x] 战斗引擎入口 (BattleEngine.ts)
- [x] 战斗管理器 (BattleManager.ts)
- [x] 帧管理器 (FrameManager.ts)
- [x] 实体管理器 (EntityManager.ts)
- [x] 技能管理器 (SkillManager.ts)
- [x] 伤害管理器 (DamageManager.ts)
- [x] 波次管理器 (WaveManager.ts)
- [x] 事件管理器 (EventManager.ts)
- [x] 随机数管理器 (RandomManager.ts)
- [x] 回放管理器 (ReplayManager.ts)
- [x] 日志系统 (Logger.ts)

### 实体系统

- [x] 实体基类 (Entity.ts)
- [x] 英雄实体 (Hero.ts)
- [x] 豆豆实体 (Bean.ts)
- [x] 水晶实体 (Crystal.ts)

### 技能系统

- [x] 技能核心 (SkillKernel)
- [x] 技能配置验证 (generate-validate.ts)

### 游戏状态管理

- [x] 全局游戏状态 (gameState)
- [x] 本地存储支持
- [x] 关卡和英雄选择状态管理

### 测试工具

- [x] 战斗引擎测试工具 (BattleTestTool.js)
- [x] 完整回放系统测试 (FullReplayTest.js)
- [x] 日志测试 (Loggertest.ts)

## 战斗引擎特性

1. **地图**
   - 地图尺寸 3000 * 3000
   - 水晶固定在 1500,1500 点出生
   - 英雄在水晶旁出生
   - 怪物(豆豆)在与水晶距离500-800的点随机产生

2. **伪随机**
   - 伪随机的确定性计算
   - 随机种子使其只记录关键指令即可复现整个战斗过程

3. **状态管理**
   - 使用确定性随机种子
   - 状态快照和回放支持
   - 断线重连机制

4. **关键帧策略**
   - 关键帧进行操作
   - 非关键帧操作全自动根据伪随机策略生成
   - 客户端预测移动

5. **状态系统**
   - 多层buff/debuff叠加
   - 状态免疫和抵抗
   - 状态持续时间管理
   - 状态效果冲突解决

6. **逻辑帧+内部帧**
   - 逻辑帧,每秒10帧
   - 内部帧率为50帧,即:每个逻辑帧进行5次内部循环
   - 少于100ms的攻击间隔采用多段攻击法进行处理
   - 高频操作(如攻击)使用独立的时间累积机制
   - 逻辑帧的事件累计后按照顺序发送

## 用户界面特性

1. **主菜单界面**
   - 开始游戏按钮
   - 设置面板
   - 制作人员信息

2. **关卡选择界面**
   - 关卡列表显示
   - 关卡难度指示
   - 关卡解锁状态

3. **英雄选择界面**
   - 英雄列表显示
   - 英雄属性和技能预览
   - 多英雄选择支持

4. **战斗界面**
   - 战斗场景渲染
   - 实体状态显示
   - 技能按钮和冷却显示

## 工作记录

详细的工作记录请查看 [Work 目录](./Work/)，按日期-工作主题进行组织。

## 待完成工作

### 事件系统完善

1. **完善事件数据类型**
   - 完善 `EventDataMap` 接口中的类型定义，替换 `any` 类型
   - 为所有事件数据接口添加必要的属性和文档注释

2. **单元测试**
   - 为事件系统添加单元测试，确保类型安全和功能正确性

3. **文档完善**
   - 编写详细的事件系统使用文档，包括示例代码
   - 为每个事件类型添加详细的文档注释

4. **性能优化**
   - 分析事件系统的性能瓶颈
   - 优化事件触发和处理的性能

### 用户界面完善

1. **技能按钮交互优化**
   - 改进技能按钮的触摸反馈
   - 优化技能冷却显示效果
   - 添加技能提示信息

2. **英雄状态显示完善**
   - 添加生命值和能量值动态显示
   - 实现状态效果图标显示
   - 优化伤害数字显示效果

3. **波次信息显示优化**
   - 添加波次进度条
   - 实现波次预告功能
   - 优化波次完成提示

4. **游戏结算界面美化**
   - 设计胜利和失败界面
   - 添加战斗统计数据显示
   - 实现奖励展示功能

### 触屏控制优化

1. **英雄移动控制精确度提升**
   - 优化触摸响应区域
   - 实现路径预测显示
   - 添加移动取消功能

2. **技能释放目标选择优化**
   - 改进目标选择指示器
   - 实现范围技能预览
   - 优化技能取消机制

3. **多点触控支持完善**
   - 实现同时移动和技能释放
   - 优化多指操作冲突处理
   - 添加手势识别功能

### 游戏进度系统

1. **关卡进度保存**
   - 实现关卡解锁机制
   - 添加关卡评星系统
   - 保存关卡通关记录

2. **英雄解锁系统**
   - 设计英雄解锁条件
   - 实现英雄购买功能
   - 添加英雄收集界面

3. **成就系统**
   - 设计游戏成就列表
   - 实现成就解锁条件检测
   - 添加成就奖励机制

## 下一步开发计划

1. 完善事件数据类型定义
2. 添加单元测试
3. 编写详细文档
4. 进行性能优化
5. 完善战斗场景的触屏控制
6. 优化用户界面组件
7. 实现游戏进度保存功能
8. 添加音效和背景音乐

## 开发环境

- TypeScript
- Phaser 3.60.0
- Vite 开发服务器
- Node.js 工具链
