# 实现英雄攻击豆豆功能

## 需求描述
实现英雄对豆豆进行攻击的功能，使英雄能够主动攻击豆豆敌人。

## 实现方案
1. 在Hero类中添加攻击相关的属性和方法
2. 在BattleCommand中添加攻击命令的定义
3. 在BattleManager中添加处理攻击命令的逻辑
4. 在EntityRenderer中为豆豆添加点击交互
5. 在TouchController中添加处理豆豆点击事件的逻辑

## 具体修改

### 1. 修改Hero类
- 添加攻击相关的属性：攻击范围、攻击间隔、上次攻击时间、目标ID等
- 添加伤害管理器和实体管理器的引用
- 添加攻击目标的方法`attackTarget`
- 添加设置和获取攻击相关属性的方法
- 在update方法中添加自动攻击目标的逻辑

### 2. 修改BattleCommand
- 添加攻击命令类型`attack`
- 添加攻击命令接口`AttackCommand`
- 更新战斗指令联合类型

### 3. 修改BattleManager
- 添加处理攻击命令的方法`processAttackCommand`
- 在processCommands方法中添加对攻击命令的处理
- 在创建英雄时设置伤害管理器和实体管理器

### 4. 修改EntityRenderer
- 为豆豆实体添加点击交互功能
- 添加点击事件，触发`beanClicked`事件
- 传递豆豆ID和位置信息

### 5. 修改TouchController
- 添加监听`beanClicked`事件
- 添加`onBeanClicked`方法处理豆豆点击事件
- 添加`attackBean`方法发送攻击命令
- 添加`castSkillAtBean`方法使用技能攻击豆豆
- 添加`playAttackVisualEffect`方法显示攻击视觉效果

## 玩家操作方式
玩家可以通过以下方式操作英雄攻击豆豆：

1. **直接点击豆豆进行普通攻击**：
   - 在战斗场景中直接点击豆豆
   - 英雄会自动发起普通攻击
   - 会显示攻击线作为视觉反馈

2. **选择技能后点击豆豆**：
   - 先点击技能按钮选择技能
   - 然后点击豆豆作为技能目标
   - 英雄会使用选中的技能攻击豆豆

## 测试方法
可以通过以下方式测试英雄攻击豆豆功能：
1. 发送攻击命令：`battleManager.sendCommand({type: 'attack', frame: currentFrame, playerId: 'player1', data: {heroId: 1, targetId: 2}})`
2. 设置英雄的目标ID：`hero.setTargetId('bean_1')`，英雄会在update方法中自动攻击目标
3. 在游戏中直接点击豆豆测试交互功能

## 注意事项
- 英雄攻击豆豆需要在攻击范围内
- 攻击有冷却时间，不能连续攻击
- 需要正确设置伤害管理器和实体管理器才能正常工作
- 豆豆需要在屏幕内才能被点击，屏幕外的豆豆需要通过指示器找到

## 更新记录

### 2025-05-06 更新：增强攻击效果和持续攻击功能

1. **区分不同实体的受击动画效果**
   - **豆豆受击效果**：
     - 红色闪烁效果
     - 较大幅度震动
     - 被压扁后弹回的缩放效果
     - 白色闪光效果

   - **英雄受击效果**：
     - 蓝色闪烁效果
     - 轻微震动
     - 短暂变暗效果
     - 轻微后仰再回正的防御姿态
     - 蓝色防护罩效果

   - **水晶受击效果**：
     - 紫色闪烁效果
     - 高频率小幅度震动
     - 发光效果
     - 紫色能量波纹扩散
     - 碎片飞散效果

2. **实现持续攻击功能**
   - 点击豆豆后，英雄会设置该豆豆为持续攻击目标
   - 英雄会在update方法中自动攻击目标
   - 当目标死亡或超出攻击范围时，会自动清除目标

3. **修复伤害事件触发**
   - 确保攻击成功后触发damageDealt事件
   - 确保豆豆死亡后触发entityDeath事件
   - 这些事件确保UI能够正确显示伤害效果和死亡动画

### 2025-05-07 更新：修复英雄攻击豆豆功能

1. **修复豆豆ID解析问题**
   - 修改了TouchController中的攻击方法，正确处理复杂格式的豆豆ID
   - 添加了fullBeanId属性，确保完整的豆豆ID能够传递给BattleManager
   - 在BattleManager中增强了目标查找逻辑，支持多种ID格式

2. **增强日志记录**
   - 在Hero类的update方法中添加了详细的日志记录
   - 记录攻击距离、攻击范围和攻击结果
   - 记录详细的伤害计算结果，便于调试

3. **修复伤害事件触发**
   - 确保在BattleManager中正确触发damageDealt事件
   - 确保在豆豆死亡时正确触发entityDeath事件
   - 添加了更多的日志记录，便于追踪事件触发流程

### 2025-05-06 更新：添加英雄攻击范围指示和攻击指示线

1. **添加攻击范围指示器**
   - 在TouchController中添加了攻击范围指示器
   - 创建了showAttackRange方法，用于显示英雄的攻击范围
   - 攻击范围以半透明红色圆圈表示

2. **增强攻击指示线效果**
   - 攻击指示线和攻击范围指示器一起显示
   - 当点击豆豆时，同时显示攻击范围和攻击线
   - 攻击范围和攻击线在攻击完成后自动消失

3. **添加超出攻击范围警告**
   - 当目标豆豆超出攻击范围时，在攻击范围边缘显示警告标记
   - 警告标记以黄色X形符号表示
   - 帮助玩家直观了解目标是否在攻击范围内

### 2025-05-06 更新：添加豆豆选中效果

1. **添加选中效果指示器**
   - 在EntityRenderer中添加了选中效果指示器
   - 当豆豆被点击时，显示紫色外圈选中效果
   - 选中效果使用脉动动画，更加醒目

2. **实现选中效果的位置更新**
   - 当豆豆移动时，选中效果会跟随豆豆移动
   - 在实体位置更新时自动更新选中效果的位置
   - 确保选中效果始终正确显示在豆豆周围

3. **处理选中效果的生命周期**
   - 当豆豆死亡时，自动清除选中效果
   - 当选择新的豆豆时，清除之前豆豆的选中效果
   - 确保同一时间只有一个豆豆显示选中效果
