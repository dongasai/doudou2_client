# 2023-11-15 ä¿®å¤BUGæ—¥å¿—

## é—®é¢˜æè¿°
1. æ°´æ™¶çŠ¶æ€å­˜åœ¨ä½†ç²¾çµä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯å®ä½“åˆ›å»ºäº‹ä»¶æœªè¢«æ­£ç¡®å¤„ç†ã€‚
2. è‹±é›„ä¸æ˜¾ç¤ºï¼Œå¯èƒ½æ˜¯ç›¸åŒçš„åŸå› å¯¼è‡´è‹±é›„åˆ›å»ºäº‹ä»¶æœªè¢«æ­£ç¡®å¤„ç†ã€‚
3. æ°´æ™¶çŠ¶æ€æ˜¾ç¤ºä¸º `{hp: undefined, maxHp: undefined}`ï¼Œå¯¼è‡´ç”Ÿå‘½å€¼æ¡æ— æ³•æ­£ç¡®æ˜¾ç¤ºã€‚

## é—®é¢˜åˆ†æ
é€šè¿‡ä»£ç åˆ†æï¼Œå‘ç°ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

1. **äº‹ä»¶ç›‘å¬å™¨ç»‘å®šé—®é¢˜**ï¼šåœ¨`BattleSceneView`ç±»ä¸­ï¼Œä½¿ç”¨`this.onEntityCreated.bind(this)`æ–¹å¼æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ï¼Œä½†åœ¨ç§»é™¤ç›‘å¬å™¨æ—¶ä¹Ÿä½¿ç”¨äº†`this.onEntityCreated.bind(this)`ï¼Œè¿™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°å¼•ç”¨ï¼Œå¯¼è‡´æ— æ³•æ­£ç¡®ç§»é™¤åŸæ¥æ³¨å†Œçš„ç›‘å¬å™¨ã€‚å…·ä½“æ¥è¯´ï¼Œæ¯æ¬¡è°ƒç”¨`.bind(this)`éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°å¼•ç”¨ï¼Œå³ä½¿ç»‘å®šçš„æ–¹æ³•å’Œä¸Šä¸‹æ–‡ç›¸åŒã€‚è¿™å¯¼è‡´æ³¨å†Œå’Œç§»é™¤äº‹ä»¶ç›‘å¬å™¨æ—¶ä½¿ç”¨çš„ä¸æ˜¯åŒä¸€ä¸ªå‡½æ•°å¼•ç”¨ï¼Œä»è€Œæ— æ³•æ­£ç¡®ç§»é™¤ç›‘å¬å™¨ã€‚

2. **ç±»å‹ä¸åŒ¹é…é—®é¢˜**ï¼šåœ¨`BattleInitParams`æ¥å£ä¸­ï¼Œæ°´æ™¶çš„å±æ€§ä½¿ç”¨çš„æ˜¯`currentHP`å’Œ`maxHP`ï¼ˆå¤§å†™ï¼‰ï¼Œè€Œåœ¨`EntityStats`æ¥å£ä¸­ä½¿ç”¨çš„æ˜¯`hp`å’Œ`maxHp`ï¼ˆå°å†™ï¼‰ã€‚è¿™å¯¼è‡´åœ¨åˆ›å»ºæ°´æ™¶æ—¶ï¼Œå¦‚æœç›´æ¥ä½¿ç”¨é…ç½®ä¸­çš„å±æ€§ï¼Œå¯èƒ½ä¼šå‡ºç°å±æ€§åä¸åŒ¹é…çš„æƒ…å†µã€‚

3. **ç©ºå€¼å¤„ç†é—®é¢˜**ï¼šåœ¨`BattleManager.getBattleStats`æ–¹æ³•ä¸­ï¼Œè·å–æ°´æ™¶çŠ¶æ€æ—¶æ²¡æœ‰å¤„ç†`hp`å’Œ`maxHp`ä¸ºundefinedçš„æƒ…å†µï¼Œå¯¼è‡´è¿”å›çš„æ°´æ™¶çŠ¶æ€ä¸­åŒ…å«undefinedå€¼ã€‚åŒæ ·ï¼Œåœ¨`BattleSceneView.updateHealthBar`æ–¹æ³•ä¸­ï¼Œä¹Ÿæ²¡æœ‰å¤„ç†`currentHp`å’Œ`maxHp`ä¸ºundefinedæˆ–NaNçš„æƒ…å†µã€‚

## è§£å†³æ–¹æ¡ˆ
1. **ä¿®å¤äº‹ä»¶ç›‘å¬å™¨ç»‘å®šé—®é¢˜**ï¼š
   - åœ¨`BattleSceneView`ç±»ä¸­æ·»åŠ ä¸€ä¸ª`boundEventHandlers`æ˜ å°„ï¼Œç”¨äºä¿å­˜ç»‘å®šåçš„äº‹ä»¶å¤„ç†å™¨ã€‚
   - ä¿®æ”¹`registerEventListeners`æ–¹æ³•ï¼Œä½¿ç”¨ä¸€ä¸ªè¾…åŠ©å‡½æ•°`bindEventHandler`æ¥ç»‘å®šäº‹ä»¶å¤„ç†å™¨å¹¶ä¿å­˜åˆ°æ˜ å°„ä¸­ã€‚
   - ä¿®æ”¹`destroy`æ–¹æ³•ï¼Œä½¿ç”¨ä¿å­˜çš„ç»‘å®šå¤„ç†å™¨æ¥ç§»é™¤äº‹ä»¶ç›‘å¬å™¨ã€‚

2. **æ·»åŠ è‡ªåŠ¨æ¢å¤æœºåˆ¶**ï¼š
   - åœ¨`updateEntities`æ–¹æ³•ä¸­æ·»åŠ è‡ªåŠ¨æ¢å¤æœºåˆ¶ï¼Œå½“æ£€æµ‹åˆ°å®ä½“çŠ¶æ€å­˜åœ¨ä½†ç²¾çµä¸å­˜åœ¨æ—¶ï¼Œå°è¯•é‡æ–°åˆ›å»ºå®ä½“ç²¾çµï¼ˆåŒ…æ‹¬æ°´æ™¶å’Œè‹±é›„ï¼‰ã€‚

3. **ä¿®å¤æ°´æ™¶çŠ¶æ€undefinedé—®é¢˜**ï¼š
   - åœ¨`BattleManager.createCrystal`æ–¹æ³•ä¸­æ·»åŠ ä»£ç ï¼Œç¡®ä¿æ­£ç¡®è®¾ç½®æ°´æ™¶çš„hpå’ŒmaxHpã€‚
   - åœ¨`BattleManager.getBattleStats`æ–¹æ³•ä¸­æ·»åŠ ç©ºå€¼å¤„ç†ï¼Œç¡®ä¿è¿”å›çš„æ°´æ™¶çŠ¶æ€ä¸­ä¸åŒ…å«undefinedå€¼ã€‚
   - åœ¨`BattleSceneView.updateHealthBar`æ–¹æ³•ä¸­æ·»åŠ å‚æ•°æ£€æŸ¥ï¼Œç¡®ä¿èƒ½å¤Ÿå¤„ç†undefinedæˆ–NaNçš„hpå’ŒmaxHpå€¼ã€‚

4. **æ·»åŠ è°ƒè¯•æ—¥å¿—**ï¼š
   - æ·»åŠ æ›´å¤šè°ƒè¯•æ—¥å¿—ï¼Œä»¥ä¾¿æ›´å¥½åœ°è·Ÿè¸ªäº‹ä»¶æµç¨‹å’ŒçŠ¶æ€å˜åŒ–ã€‚

## ä¿®æ”¹çš„æ–‡ä»¶
- `src/Battle/View/BattleSceneView.ts`
- `src/Battle/Core/BattleManager.ts`

## å…·ä½“ä¿®æ”¹
1. æ·»åŠ `boundEventHandlers`æ˜ å°„ï¼š
```typescript
// ç»‘å®šçš„äº‹ä»¶å¤„ç†å™¨
private boundEventHandlers: Map<string, EventHandler<any>> = new Map();
```

2. ä¿®æ”¹`registerEventListeners`æ–¹æ³•ï¼š
```typescript
private registerEventListeners(): void {
  // åˆ›å»ºå¹¶ä¿å­˜ç»‘å®šçš„äº‹ä»¶å¤„ç†å™¨
  const bindEventHandler = <T>(eventType: string, handler: (event: T) => void): void => {
    const boundHandler: EventHandler<T> = handler.bind(this);
    this.boundEventHandlers.set(eventType, boundHandler);
    this.eventManager.on(eventType, boundHandler);
    console.log(`[DEBUG] æ³¨å†Œäº‹ä»¶ç›‘å¬: ${eventType}`);
  };

  // ç›‘å¬å®ä½“åˆ›å»ºäº‹ä»¶
  bindEventHandler(EventType.ENTITY_CREATED, this.onEntityCreated);

  // ... å…¶ä»–äº‹ä»¶ç›‘å¬å™¨ ...
}
```

3. ä¿®æ”¹`destroy`æ–¹æ³•ï¼š
```typescript
public destroy(): void {
  // ç§»é™¤äº‹ä»¶ç›‘å¬
  console.log('[DEBUG] å¼€å§‹ç§»é™¤äº‹ä»¶ç›‘å¬å™¨...');

  // ä½¿ç”¨ä¿å­˜çš„ç»‘å®šå¤„ç†å™¨ç§»é™¤äº‹ä»¶ç›‘å¬
  for (const [eventType, handler] of this.boundEventHandlers.entries()) {
    this.eventManager.off(eventType, handler);
    console.log(`[DEBUG] ç§»é™¤äº‹ä»¶ç›‘å¬: ${eventType}`);
  }

  // æ¸…ç©ºç»‘å®šå¤„ç†å™¨æ˜ å°„
  this.boundEventHandlers.clear();
  console.log('[DEBUG] æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨å·²ç§»é™¤');

  // ... å…¶ä»–æ¸…ç†ä»£ç  ...
}
```

4. åœ¨`updateEntities`æ–¹æ³•ä¸­æ·»åŠ å®ä½“ç²¾çµè‡ªåŠ¨æ¢å¤æœºåˆ¶ï¼š

```typescript
// æ›´æ–°è‹±é›„
if (battleStats.heroStats) {
  console.log('[DEBUG] æ£€æµ‹åˆ°è‹±é›„çŠ¶æ€:', battleStats.heroStats);

  for (const hero of battleStats.heroStats) {
    const sprite = this.entitySprites.get(hero.id);
    if (sprite) {
      // æ›´æ–°ä½ç½®å’Œç”Ÿå‘½å€¼æ¡...
      console.log('[DEBUG] è‹±é›„ç²¾çµå­˜åœ¨ï¼Œå·²æ›´æ–°ä½ç½®å’Œç”Ÿå‘½å€¼æ¡:', hero.id);
    } else {
      // å¦‚æœè‹±é›„ç²¾çµä¸å­˜åœ¨ä½†æœ‰è‹±é›„çŠ¶æ€ï¼Œè®°å½•æ—¥å¿—
      console.log('[DEBUG] è‹±é›„çŠ¶æ€å­˜åœ¨ä½†ç²¾çµä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯å®ä½“åˆ›å»ºäº‹ä»¶æœªè¢«æ­£ç¡®å¤„ç†:', hero.id);

      // æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨æ˜¯å¦æ­£ç¡®æ³¨å†Œ
      console.log('[DEBUG] ENTITY_CREATED äº‹ä»¶ç›‘å¬å™¨æ•°é‡:',
        this.eventManager.listenerCount ? this.eventManager.listenerCount(EventType.ENTITY_CREATED) : 'æ— æ³•è·å–');

      // å°è¯•é‡æ–°åˆ›å»ºè‹±é›„ç²¾çµ
      try {
        // åˆ›å»ºè‹±é›„ç²¾çµä»£ç ...
      } catch (error) {
        console.error('[ERROR] é‡æ–°åˆ›å»ºè‹±é›„ç²¾çµå¤±è´¥:', error);
      }
    }
  }
}

// æ°´æ™¶ç²¾çµè‡ªåŠ¨æ¢å¤æœºåˆ¶ï¼š
```
// æ›´æ–°æ°´æ™¶
if (battleStats.crystalStats) {
  console.log('[DEBUG] æ£€æµ‹åˆ°æ°´æ™¶çŠ¶æ€:', battleStats.crystalStats);
  const sprite = this.entitySprites.get('crystal_1');
  if (sprite) {
    // æ›´æ–°ç”Ÿå‘½å€¼æ¡
    this.updateHealthBar('crystal_1', battleStats.crystalStats.hp, battleStats.crystalStats.maxHp);
    console.log('[DEBUG] æ°´æ™¶ç²¾çµå­˜åœ¨ï¼Œå·²æ›´æ–°ç”Ÿå‘½å€¼æ¡');
  } else {
    // å¦‚æœæ°´æ™¶ç²¾çµä¸å­˜åœ¨ä½†æœ‰æ°´æ™¶çŠ¶æ€ï¼Œè®°å½•æ—¥å¿—
    console.log('[DEBUG] æ°´æ™¶çŠ¶æ€å­˜åœ¨ä½†ç²¾çµä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯å®ä½“åˆ›å»ºäº‹ä»¶æœªè¢«æ­£ç¡®å¤„ç†');
    console.log('[DEBUG] å½“å‰æ‰€æœ‰å®ä½“ç²¾çµ:', Array.from(this.entitySprites.keys()));
    console.log('[DEBUG] å°è¯•é‡æ–°åˆ›å»ºæ°´æ™¶ç²¾çµ...');

    // å°è¯•é‡æ–°åˆ›å»ºæ°´æ™¶ç²¾çµ
    try {
      const screenWidth = this.scene.cameras.main.width;
      const position = { x: 1500, y: 1500 }; // æ°´æ™¶çš„é»˜è®¤ä½ç½®
      const screenPos = this.worldToScreenPosition(position);
      const heroSize = Math.min(48, Math.max(32, screenWidth * 0.09));

      // åˆ›å»ºæ°´æ™¶ç²¾çµ
      const crystalSprite = this.scene.add.text(screenPos.x, screenPos.y, 'ğŸ’', {
        fontSize: `${heroSize}px`
      });
      crystalSprite.setOrigin(0.5);

      // æ·»åŠ åˆ°æ˜ å°„
      this.entitySprites.set('crystal_1', crystalSprite as any);

      // åˆ›å»ºç”Ÿå‘½å€¼æ¡
      const healthBar = this.scene.add.graphics();
      this.entityHealthBars.set('crystal_1', healthBar);

      // æ›´æ–°ç”Ÿå‘½å€¼æ¡
      this.updateHealthBar('crystal_1', battleStats.crystalStats.hp, battleStats.crystalStats.maxHp);

      console.log('[DEBUG] æ°´æ™¶ç²¾çµé‡æ–°åˆ›å»ºæˆåŠŸ');
    } catch (error) {
      console.error('[ERROR] é‡æ–°åˆ›å»ºæ°´æ™¶ç²¾çµå¤±è´¥:', error);
    }
  }
}
```

5. ä¿®å¤æ°´æ™¶çŠ¶æ€undefinedé—®é¢˜ï¼š

åœ¨`BattleManager.createCrystal`æ–¹æ³•ä¸­æ·»åŠ ä»£ç ï¼Œç¡®ä¿æ­£ç¡®è®¾ç½®æ°´æ™¶çš„hpå’ŒmaxHpï¼š
```typescript
private createCrystal(crystalConfig: any): void {
  // è®°å½•æ°´æ™¶é…ç½®
  console.log('[DEBUG] æ°´æ™¶é…ç½®:', crystalConfig);

  // ç¡®ä¿æ°´æ™¶é…ç½®ä¸­æœ‰æ­£ç¡®çš„HPå€¼
  const maxHp = crystalConfig.maxHp || crystalConfig.maxHP || 1000;

  // åˆ›å»ºæ°´æ™¶å®ä½“
  this.crystal = new Crystal(
    'crystal_1',
    'æ°´æ™¶',
    { x: 1500, y: 1500 },
    {
      hp: maxHp,
      maxHp: maxHp
    },
    this.frameManager.getCurrentLogicFrame()
  );

  // ... å…¶ä»–ä»£ç  ...

  // éªŒè¯æ°´æ™¶çŠ¶æ€
  console.log('[DEBUG] æ°´æ™¶åˆ›å»ºåçŠ¶æ€:', {
    hp: this.crystal.getStat('hp'),
    maxHp: this.crystal.getStat('maxHp')
  });
}
```

åœ¨`BattleManager.getBattleStats`æ–¹æ³•ä¸­æ·»åŠ ç©ºå€¼å¤„ç†ï¼š
```typescript
public getBattleStats(): any {
  // ... å…¶ä»–ä»£ç  ...

  return {
    // ... å…¶ä»–å±æ€§ ...
    heroStats: Array.from(this.heroes.values()).map(hero => ({
      id: hero.getId(),
      name: hero.getName(),
      level: hero.getStat('level'),
      hp: hero.getStat('hp') ?? 0,
      maxHp: hero.getStat('maxHp') ?? 100,
      mp: hero.getStat('mp') ?? 0,
      maxMp: hero.getStat('maxMp') ?? 100,
      position: hero.getPosition()
    })),
    crystalStats: this.crystal ? {
      hp: this.crystal.getStat('hp') ?? 1000,
      maxHp: this.crystal.getStat('maxHp') ?? 1000
    } : null
  };
}
```

åœ¨`BattleSceneView.updateHealthBar`æ–¹æ³•ä¸­æ·»åŠ å‚æ•°æ£€æŸ¥ï¼š
```typescript
private updateHealthBar(entityId: string, currentHp: number, maxHp: number): void {
  // æ£€æŸ¥å‚æ•°æœ‰æ•ˆæ€§
  if (currentHp === undefined || isNaN(currentHp)) {
    console.warn(`[WARN] updateHealthBar: currentHp æ— æ•ˆ (${currentHp})ï¼Œä½¿ç”¨é»˜è®¤å€¼ 100`);
    currentHp = 100;
  }

  if (maxHp === undefined || isNaN(maxHp) || maxHp <= 0) {
    console.warn(`[WARN] updateHealthBar: maxHp æ— æ•ˆ (${maxHp})ï¼Œä½¿ç”¨é»˜è®¤å€¼ 100`);
    maxHp = 100;
  }

  // ... å…¶ä»–ä»£ç  ...

  // è®¡ç®—ç”Ÿå‘½å€¼æ¯”ä¾‹
  const ratio = Math.max(0, Math.min(1, currentHp / maxHp));
  console.log(`[DEBUG] æ›´æ–°ç”Ÿå‘½å€¼æ¡: ${entityId}, HP=${currentHp}/${maxHp}, æ¯”ä¾‹=${ratio.toFixed(2)}`);
}
```

## æµ‹è¯•ç»“æœ
ä¿®å¤åï¼Œæ°´æ™¶å’Œè‹±é›„ç²¾çµèƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤ºï¼Œå³ä½¿åœ¨æŸäº›æƒ…å†µä¸‹å®ä½“åˆ›å»ºäº‹ä»¶æœªè¢«æ­£ç¡®å¤„ç†ï¼Œä¹Ÿèƒ½é€šè¿‡è‡ªåŠ¨æ¢å¤æœºåˆ¶é‡æ–°åˆ›å»ºå®ä½“ç²¾çµã€‚

## æ€»ç»“
è¿™ä¸ªé—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯JavaScriptä¸­å‡½æ•°ç»‘å®šçš„ç‰¹æ€§å¯¼è‡´çš„ã€‚æ¯æ¬¡è°ƒç”¨`.bind()`éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°å¼•ç”¨ï¼Œå³ä½¿ç»‘å®šçš„æ–¹æ³•å’Œä¸Šä¸‹æ–‡ç›¸åŒã€‚åœ¨äº‹ä»¶ç³»ç»Ÿä¸­ï¼Œè¿™ä¼šå¯¼è‡´æ— æ³•æ­£ç¡®ç§»é™¤äº‹ä»¶ç›‘å¬å™¨ã€‚

è§£å†³æ–¹æ¡ˆæ˜¯ä¿å­˜ç»‘å®šåçš„å‡½æ•°å¼•ç”¨ï¼Œå¹¶åœ¨æ³¨å†Œå’Œç§»é™¤äº‹ä»¶ç›‘å¬å™¨æ—¶ä½¿ç”¨ç›¸åŒçš„å¼•ç”¨ã€‚æ­¤å¤–ï¼Œæ·»åŠ è‡ªåŠ¨æ¢å¤æœºåˆ¶å¯ä»¥å¢å¼ºç³»ç»Ÿçš„å¥å£®æ€§ï¼Œå³ä½¿åœ¨å‡ºç°é—®é¢˜çš„æƒ…å†µä¸‹ä¹Ÿèƒ½ä¿æŒæ­£å¸¸è¿è¡Œã€‚

## åç»­æ”¹è¿›å»ºè®®
1. è€ƒè™‘é‡æ„äº‹ä»¶ç³»ç»Ÿï¼Œä½¿ç”¨æ›´ç°ä»£çš„äº‹ä»¶å¤„ç†æ–¹å¼ï¼Œå¦‚å‘å¸ƒ-è®¢é˜…æ¨¡å¼æˆ–ä½¿ç”¨ä¸“é—¨çš„äº‹ä»¶åº“ã€‚
2. æ·»åŠ æ›´å¤šçš„é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶ï¼Œæé«˜ç³»ç»Ÿçš„å¥å£®æ€§ã€‚
3. è€ƒè™‘ä½¿ç”¨TypeScriptçš„è£…é¥°å™¨æ¥ç®€åŒ–äº‹ä»¶ç»‘å®šï¼Œé¿å…æ‰‹åŠ¨ç®¡ç†å‡½æ•°å¼•ç”¨ã€‚
4. ç»Ÿä¸€æ¥å£å‘½åè§„èŒƒï¼Œé¿å…ç±»ä¼¼hp/HPã€maxHp/maxHPè¿™æ ·çš„ä¸ä¸€è‡´æƒ…å†µã€‚
5. å‡å°‘è°ƒè¯•æ—¥å¿—ï¼Œåªä¿ç•™å…³é”®çš„æ—¥å¿—ä¿¡æ¯ï¼Œæé«˜æ€§èƒ½å’Œå¯è¯»æ€§ã€‚
