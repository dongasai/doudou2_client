# 2025-05-06 修复BUG

## 修复豆豆不能移动/攻击的问题

### 问题描述
用户反馈在战斗场景中，豆豆不能移动和攻击，导致游戏无法正常进行。同时，日志中出现错误：`[ERROR] 事件处理器异常: entityMoved - {}`，表明在处理实体移动事件时出现了异常。

### 问题分析
通过代码分析，发现以下几个可能的原因：

1. **豆豆状态问题**：豆豆的移动和攻击是基于状态的（`BeanState`），如果豆豆的状态没有正确设置为`MOVE`或`ATTACK`，它们就不会执行相应的行为。

2. **目标设置问题**：豆豆需要有一个有效的目标（通过`setTarget`方法设置），如果没有目标，豆豆就不会移动或攻击。

3. **实体更新问题**：豆豆的更新是通过`EntityManager.updateAllEntities`方法调用`Bean.update`方法实现的，如果这个更新流程有问题，豆豆就不会执行移动和攻击行为。

4. **事件传递问题**：豆豆的创建和状态变化需要通过事件系统传递到视图层，如果事件没有正确触发或处理，豆豆在视图上就不会显示移动或攻击。特别是，`entityMoved`事件的数据结构与`EntityMovedEvent`接口不匹配，导致事件处理器异常。

5. **渲染问题**：即使豆豆在逻辑上正确移动和攻击，如果渲染层没有正确更新，用户也不会看到豆豆的移动和攻击效果。

### 解决方案

1. **增强日志记录**：在关键方法中添加详细的日志记录，以便更好地追踪豆豆的状态和行为。

2. **修复豆豆状态管理**：
   - 在`Bean.update`方法中，确保豆豆在空闲状态但有目标时自动切换到移动状态
   - 添加对死亡状态的处理，确保死亡的豆豆不执行任何行为

3. **改进目标设置**：
   - 在`BattleManager.createBeanFromWaveManager`方法中，添加更详细的日志记录，确保豆豆正确设置了目标
   - 在`Bean.moveToTarget`和`Bean.attackTarget`方法中，添加对目标不存在情况的处理

4. **增强实体更新机制**：
   - 修改`EntityManager.updateAllEntities`方法，使其能够检测实体位置变化并触发相应的事件
   - 修改`BattleManager.onFrameUpdate`方法，确保在更新实体时传递事件管理器

5. **改进事件传递**：
   - 确保实体移动事件能够正确触发和处理，使视图层能够及时更新豆豆的位置
   - 使用`EventType`枚举常量而不是字符串来触发事件，提高代码的可维护性和避免拼写错误
   - 修复`entityMoved`事件数据结构，使其与`EntityMovedEvent`接口匹配，解决事件处理器异常问题

### 修改的文件
1. `src/Battle/Core/BattleManager.ts`
   - 增强豆豆创建和目标设置的日志记录
   - 修改`onFrameUpdate`方法，传递事件管理器

2. `src/Battle/Entities/Bean.ts`
   - 改进`update`方法，增强状态管理
   - 改进`moveToTarget`方法，增强目标处理和日志记录
   - 改进`attackTarget`方法，增强目标处理和日志记录

3. `src/Battle/Core/EntityManager.ts`
   - 修改`updateAllEntities`方法，检测实体位置变化并触发事件
   - 导入并使用`EventType`枚举常量来触发事件
   - 修复`entityMoved`事件数据结构，确保与`EntityMovedEvent`接口匹配

### 效果
修复后，豆豆能够正确移动和攻击，游戏可以正常进行。同时，通过增强的日志记录，可以更好地追踪豆豆的状态和行为，便于后续调试和优化。

### 后续工作
1. 考虑进一步优化豆豆的AI逻辑，使其行为更加智能和自然
2. 考虑添加更多的豆豆类型和行为模式，增加游戏的多样性和挑战性
3. 考虑优化事件系统，减少不必要的事件触发，提高性能
