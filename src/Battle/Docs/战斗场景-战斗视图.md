# 战斗场景战斗视图文档

## 概述

战斗场景战斗视图是豆豆防御战游戏中负责将战斗逻辑转换为可视化表现的核心组件。它将战斗引擎中的状态和事件转换为玩家可以看到的游戏画面，包括实体渲染、动画效果、摄像机控制等。战斗视图与战斗逻辑完全分离，通过事件系统进行通信，确保视图层和逻辑层的解耦。

## 战斗视图组成

战斗视图由以下主要组件构成：

1. **战斗场景视图**：整个战斗视图的核心，协调各个子组件
2. **实体渲染器**：负责渲染英雄、豆豆、水晶等实体
3. **摄像机控制器**：控制游戏视角和坐标转换
4. **技能效果视图**：展示技能释放的视觉效果
5. **触摸控制器**：处理玩家的触摸输入
6. **屏幕外指示器管理器**：显示屏幕外实体的方向指示

### 战斗视图内容组成

战斗视图的内容由以下主要元素组成：

#### 1. 战斗场景背景

战斗场景的背景是一个纯黑色的背景，用于突出战斗实体和效果。背景的尺寸为3000x3000像素，与战斗逻辑中的世界坐标系统保持一致。

```typescript
// 创建背景
private createBackground(): void {
  // 创建纯黑色背景
  const background = this.scene.add.rectangle(
    1500, 1500,  // 世界中心点
    3000, 3000,  // 世界大小
    0x000000     // 黑色
  );
  background.setDepth(DepthLayers.BACKGROUND);
}
```

#### 2. 战斗实体

战斗实体是战斗场景中最重要的视觉元素，包括：

- **英雄实体**：玩家控制的角色，使用🧙表情符号表示
- **豆豆实体**：敌人单位，根据类型使用不同的表情符号
  - 普通豆：🟢
  - 快速豆：🔵
  - 强壮豆：🟤
  - 毒豆：💚
  - 炸弹豆：💣
  - 冰霜豆：❄️
  - 铁甲豆：🛡️
  - 狂暴豆：😡
  - BOSS豆：👑
- **水晶实体**：防御目标，使用💎表情符号表示

每个实体都有自己的状态显示：

- **生命值条**：显示实体当前生命值
- **状态图标**：显示实体当前状态（如眩晕、中毒等）
- **动作动画**：显示实体当前动作（如攻击、受击等）

#### 3. 战斗效果

战斗效果用于增强战斗的视觉表现，包括：

- **技能效果**：技能释放时的视觉效果，如火球、冰霜箭等
- **伤害数字**：实体受到伤害时显示的数字
- **状态效果**：实体状态变化时的视觉效果，如眩晕星星、中毒烟雾等
- **环境效果**：战斗环境的视觉效果，如波次开始时的闪光、游戏结束时的爆炸等

#### 4. 交互元素

交互元素用于玩家与游戏的交互，包括：

- **技能范围指示器**：显示技能的作用范围
- **目标指示器**：显示技能的目标位置
- **方向线**：显示拖动的方向和距离
- **屏幕外指示器**：显示屏幕外实体的方向

#### 5. 视觉反馈

视觉反馈用于增强玩家的游戏体验，包括：

- **命中反馈**：技能命中目标时的视觉反馈
- **受击反馈**：实体受到伤害时的视觉反馈
- **死亡动画**：实体死亡时的视觉效果
- **胜利/失败效果**：游戏结束时的视觉效果

### 战斗视图层级结构

战斗视图使用层级系统来管理不同元素的显示顺序：

```typescript
// 层级常量
export enum DepthLayers {
  BACKGROUND = 0,        // 背景层
  WORLD_GROUND = 10,     // 地面层
  WORLD_ENTITY = 20,     // 实体层
  WORLD_EFFECT = 30,     // 效果层
  WORLD_PROJECTILE = 40, // 投射物层
  WORLD_OVERLAY = 50,    // 世界覆盖层
  UI_BACKGROUND = 100,   // UI背景层
  UI_ELEMENT = 110,      // UI元素层
  UI_OVERLAY = 120,      // UI覆盖层
  UI_TOOLTIP = 130,      // UI提示层
  UI_MODAL = 140,        // UI模态层
  UI_NOTIFICATION = 150  // UI通知层
}
```

不同的视觉元素会被分配到不同的层级，确保正确的显示顺序：

1. 背景位于最底层
2. 地面效果（如技能范围指示）位于地面层
3. 实体（英雄、豆豆、水晶）位于实体层
4. 技能效果位于效果层
5. 投射物（如火球）位于投射物层
6. UI元素位于UI层，始终显示在最上层

## 战斗场景视图

战斗场景视图是整个战斗视图的核心，负责初始化和协调各个子组件：

```typescript
export class BattleSceneView {
  private scene: Phaser.Scene;
  private battleEngine: BattleEngine;
  private eventManager: EventManager;

  // 组件
  private entityRenderer: EntityRenderer;
  private uiManager: UIManager;
  private cameraController: CameraController;
  private skillEffectView: SkillEffectView;
  private eventHandlers: EventHandlers;
  private touchController: TouchController;
  private offscreenIndicatorManager: OffscreenIndicatorManager;

  // 初始化方法
  constructor(scene: Phaser.Scene, battleEngine: BattleEngine) {
    // 初始化各个组件
    // ...
  }

  // 更新方法
  public update(time: number, delta: number): void {
    // 更新各个组件
    // ...
  }
}
```

### 初始化流程

战斗场景视图的初始化流程如下：

1. 初始化摄像机控制器
2. 初始化技能效果视图
3. 初始化实体渲染器
4. 初始化屏幕外指示器管理器
5. 初始化UI管理器
6. 初始化触摸控制器
7. 初始化事件处理器
8. 触发初始化事件

## 实体渲染器

实体渲染器负责将战斗实体（英雄、豆豆、水晶）渲染到游戏场景中：

```typescript
export class EntityRenderer {
  private scene: Phaser.Scene;
  private cameraController: CameraController;

  // 实体显示对象
  private entitySprites: Map<string, Phaser.GameObjects.Sprite>;

  // 伤害数字组
  private damageTexts: Phaser.GameObjects.Group;

  // 屏幕外指示器管理器
  private offscreenIndicatorManager: any = null;

  // 实体表情符号映射 (实体ID -> 表情符号)
  private entityEmojis: Map<string, string> = new Map();

  // 创建实体精灵
  public createEntitySprite(event: EntityCreatedEvent): void {
    // 创建实体精灵
    // ...
  }

  // 更新实体位置
  public updateEntityPosition(entityId: string, position: Vector2D, animate: boolean): void {
    // 更新实体位置
    // ...
  }

  // 显示伤害数字
  public showDamageNumber(position: Point, amount: number, isCritical: boolean): void {
    // 显示伤害数字
    // ...
  }

  // 播放受击动画
  public playHitAnimation(entityId: string): void {
    // 播放受击动画
    // ...
  }
}
```

### 实体表现

不同类型的实体有不同的视觉表现：

1. **英雄**：使用 🧙 表情符号，大小为屏幕宽度的9%
2. **豆豆**：根据豆豆类型使用不同的表情符号，大小为屏幕宽度的6%
3. **水晶**：使用 💎 表情符号，大小为屏幕宽度的9%

### 伤害显示

当实体受到伤害时，会在实体上方显示伤害数字：

- 普通伤害：白色数字，16px字体
- 暴击伤害：红色数字，24px字体，加粗

伤害数字会向上飘动并逐渐消失，持续时间为1秒。

## 摄像机控制器

摄像机控制器负责控制游戏视角和坐标转换：

```typescript
export class CameraController {
  private scene: Phaser.Scene;

  // 相机配置
  private zoomFactor: number = 2.0; // 默认缩放因子，值越大视角越近
  private worldCenterX: number = 1500; // 世界中心X坐标
  private worldCenterY: number = 1500; // 世界中心Y坐标
  private worldSize: number = 3000; // 世界大小

  // 世界坐标转屏幕坐标
  public worldToScreenPosition(position: Vector2D): Vector2D {
    // 世界坐标转屏幕坐标
    // ...
  }

  // 屏幕坐标转世界坐标
  public screenToWorldPosition(screenPos: Vector2D): Vector2D {
    // 屏幕坐标转世界坐标
    // ...
  }

  // 聚焦到指定位置
  public focusOnPosition(position: Vector2D, duration: number = 300): void {
    // 聚焦到指定位置
    // ...
  }

  // 设置缩放级别
  public setZoom(zoomLevel: number): void {
    // 设置缩放级别
    // ...
  }
}
```

### 坐标系统

战斗场景使用两种坐标系统：

1. **世界坐标**：游戏逻辑使用的坐标系统，范围是0-3000（x和y方向）
2. **屏幕坐标**：实际显示在屏幕上的像素坐标，范围是0-屏幕宽高

摄像机控制器提供了两种坐标系统之间的转换方法。

### 摄像机行为

摄像机默认聚焦在英雄位置，并会平滑地跟随英雄移动。摄像机的缩放级别为1.5，可以根据需要调整。

## 技能效果视图

技能效果视图负责展示技能释放的视觉效果：

```typescript
export class SkillEffectView {
  private scene: Phaser.Scene;
  private effectsGroup: Phaser.GameObjects.Group;

  // 播放技能效果
  public playSkillEffect(
    skillId: string,
    sourcePosition: Vector2D,
    targetPosition: Vector2D,
    onComplete?: () => void
  ): void {
    // 播放技能效果
    // ...
  }

  // 播放效果动画
  public playEffectAnimation(
    effectType: EffectType,
    position: Vector2D,
    onComplete?: () => void
  ): void {
    // 播放效果动画
    // ...
  }

  // 创建粒子效果
  private createParticleEffect(emoji: string, position: Vector2D): void {
    // 创建粒子效果
    // ...
  }
}
```

### 技能视觉效果

不同类型的技能有不同的视觉效果：

1. **伤害技能**：如火球术（🔥）、冰霜箭（❄️）
2. **治疗技能**：如治疗术（💚）
3. **增益技能**：如加速（⚡）
4. **控制技能**：如眩晕（💫）

技能效果通常包括以下元素：

- 技能图标（表情符号）
- 粒子效果
- 动画效果（缩放、旋转、移动等）
- 命中效果

### 技能视觉配置

技能的视觉效果通过配置文件定义：

```typescript
export const skillVisualConfigs: Record<string, SkillVisualConfig> = {
  // 火球术
  'skill_1': {
    id: 'skill_1',
    visualEffect: {
      id: 'fireball_effect',
      name: '火球效果',
      type: SkillType.DAMAGE,
      emoji: '🔥',
      castEmoji: '💥',
      hitEmoji: '💥',
      particleEmoji: '✨',
      duration: 500,
      scale: 1.2,
      color: '#ff0000',
      travelSpeed: 300,
      rotationSpeed: 5,
      alpha: 0.8
    },
    uiConfig: {
      id: 'skill_1',
      name: '火球术',
      description: '向目标发射一个火球，造成魔法伤害',
      emoji: '🔥',
      cooldown: 5,
      cost: 20,
      type: 'damage',
      color: '#ff0000',
      borderColor: '#aa0000'
    }
  },
  // 其他技能...
};
```

## 触摸控制器

触摸控制器负责处理玩家的触摸输入，包括技能释放和移动控制：

```typescript
export class TouchController {
  private scene: Phaser.Scene;
  private battleEngine: BattleEngine;

  // 触摸状态
  private isTouchActive: boolean = false;
  private selectedSkillId: string | null = null;
  private touchStartPosition: Vector2D | null = null;
  private currentTouchPosition: Vector2D | null = null;

  // 视觉元素
  private targetIndicator: Phaser.GameObjects.Image;
  private rangeIndicator: Phaser.GameObjects.Graphics;
  private directionLine: Phaser.GameObjects.Graphics;

  // 移动模式枚举
  private mode: 'skill' | 'move' = 'skill';

  // 指针按下事件处理
  private onPointerDown(pointer: Phaser.Input.Pointer): void {
    // 处理指针按下事件
    // ...
  }

  // 指针移动事件处理
  private onPointerMove(pointer: Phaser.Input.Pointer): void {
    // 处理指针移动事件
    // ...
  }

  // 指针抬起事件处理
  private onPointerUp(pointer: Phaser.Input.Pointer): void {
    // 处理指针抬起事件
    // ...
  }
}
```

### 输入模式

触摸控制器支持两种输入模式：

1. **技能模式**：选择技能后，点击屏幕释放技能
2. **移动模式**：未选择技能时，拖动屏幕控制英雄移动

### 视觉反馈

触摸控制器提供以下视觉反馈：

- 技能范围指示器：显示技能的作用范围
- 目标指示器：显示技能的目标位置
- 方向线：显示拖动的方向和距离

## 屏幕外指示器管理器

屏幕外指示器管理器负责显示屏幕外实体的方向指示：

```typescript
export class OffscreenIndicatorManager {
  private scene: Phaser.Scene;
  private cameraController: CameraController;
  
  // 指示器映射 (实体ID -> 指示器对象)
  private indicators: Map<string, Phaser.GameObjects.Container> = new Map();
  
  // 边缘距离 (指示器与屏幕边缘的距离)
  private edgePadding: number = 20;
  
  // 更新指示器
  public updateIndicator(entityId: string, worldPosition: Vector2D, emoji: string, isVisible: boolean): void {
    // 更新指示器
    // ...
  }
  
  // 创建或更新指示器
  private createOrUpdateIndicator(entityId: string, worldPosition: Vector2D, emoji: string): void {
    // 创建或更新指示器
    // ...
  }
  
  // 计算指示器位置
  private calculateIndicatorPosition(worldPosition: Vector2D): Vector2D {
    // 计算指示器位置
    // ...
  }
}
```

### 指示器外观

屏幕外指示器由以下元素组成：

1. **背景**：半透明黑色圆形
2. **箭头**：指向实体的白色三角形
3. **图标**：实体的表情符号

指示器会显示在屏幕边缘，指向屏幕外的实体。当实体进入屏幕时，指示器会自动隐藏。

## 事件处理

战斗视图通过事件系统与战斗逻辑交互，主要处理以下事件：

1. **实体事件**：创建、移动、状态变化、死亡等
2. **战斗事件**：开始、暂停、结束等
3. **波次事件**：波次开始、波次完成等
4. **技能事件**：技能使用、冷却更新等

```typescript
export class EventHandlers {
  private entityRenderer: EntityRenderer;
  private uiManager: UIManager;
  private cameraController: CameraController;
  private skillEffectView: SkillEffectView;
  private eventManager: EventManager;
  private battleEngine: BattleEngine;

  // 注册事件监听器
  private registerEventListeners(): void {
    // 注册事件监听器
    // ...
  }

  // 实体创建事件处理
  private onEntityCreated(event: EntityCreatedEvent): void {
    // 处理实体创建事件
    // ...
  }

  // 实体移动事件处理
  private onEntityMoved(event: EntityMovedEvent): void {
    // 处理实体移动事件
    // ...
  }

  // 伤害事件处理
  private onDamageDealt(event: DamageDealtEvent): void {
    // 处理伤害事件
    // ...
  }

  // 技能使用事件处理
  private onSkillUsed(event: SkillUsedEvent): void {
    // 处理技能使用事件
    // ...
  }
}
```

## 性能优化

为了确保战斗视图的流畅运行，采取了以下性能优化措施：

1. **对象池**：使用对象池管理频繁创建和销毁的对象，如伤害数字和效果动画
2. **视图裁剪**：只渲染摄像机视野内的实体
3. **帧率控制**：战斗场景的帧率设置为30fps，平衡性能和流畅度
4. **懒加载**：延迟加载不立即需要的资源
5. **事件节流**：对频繁触发的事件进行节流处理，减少视图更新频率

## 屏幕适配

战斗视图支持不同分辨率的设备，主要通过以下方式实现：

1. **相对尺寸**：实体大小基于屏幕宽度的百分比
2. **自适应布局**：UI元素位置基于屏幕尺寸动态计算
3. **缩放控制**：根据设备分辨率调整摄像机缩放级别

目标设备为手机屏幕（430*930），布局策略为自适应布局，根据屏幕尺寸调整UI元素位置和大小。

## 后续优化方向

1. **精灵动画**：替换静态表情符号为动画精灵
2. **粒子系统**：使用Phaser的粒子系统实现更丰富的视觉效果
3. **过渡动画**：添加场景切换和状态变化的过渡动画
4. **视觉反馈**：增强玩家操作的视觉反馈
5. **优化渲染**：使用WebGL优化渲染性能
